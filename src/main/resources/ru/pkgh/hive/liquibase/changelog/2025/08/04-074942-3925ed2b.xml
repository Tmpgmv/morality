<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd"
        objectQuotingStrategy="QUOTE_ONLY_RESERVED_WORDS">
    <changeSet id="1" author="hive">
        <createTable remarks="Поверили обещанию." tableName="HIVE_ACCEPTANCE_OF_PROMISE">
            <column name="ID" type="UUID">
                <constraints nullable="false" primaryKey="true" primaryKeyName="PK_HIVE_ACCEPTANCE_OF_PROMISE"/>
            </column>
            <column name="CREATED_AT" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="EMPLOYEE_ID" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="PROMISE_ID" remarks="Обещание студента." type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="COMMENT_" remarks="Комментарий." type="CLOB"/>
        </createTable>
    </changeSet>
    <changeSet id="2" author="hive">
        <createTable
                remarks="Коллекция фраз для принятия обещания или объяснительной записки.&#10;Фраз не должно быть много. 5-6 достаточно.&#10;Например, &quot;Мы принимаем Ваше обещание, но выносим предупреждение.&quot;."
                tableName="HIVE_ACCEPTANCE_PHRASE">
            <column name="ID" type="UUID">
                <constraints nullable="false" primaryKey="true" primaryKeyName="PK_HIVE_ACCEPTANCE_PHRASE"/>
            </column>
            <column name="TEXT" type="VARCHAR(1000)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="3" author="hive">
        <createTable
                remarks="Собрать всю историю, касательно конкретного проступка.&#10;Это позволит вывести ее для пользователя."
                tableName="HIVE_HISTORY">
            <column name="ID" type="UUID">
                <constraints nullable="false" primaryKey="true" primaryKeyName="PK_HIVE_HISTORY"/>
            </column>
            <column name="MISDEMEANOR_ID" remarks="Ссылка на проступок." type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="TIMESTAMP_" remarks="Время." type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="STEP" remarks="Что именно предпринято." type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="LINK" remarks="Гиперссылка для получения детальной информации." type="VARCHAR(1000)"/>
        </createTable>
    </changeSet>
    <changeSet id="4" author="hive">
        <createTable
                remarks="Коллекция фраз для отказа. Их не должно быть много: 5-6.&#10;Что-то вроде: &quot;Неубедительно&quot;, &quot;Вы не выполняете обещания, вынуждены отказать&quot;."
                tableName="HIVE_REJECTION_PHRASE">
            <column name="ID" type="UUID">
                <constraints nullable="false" primaryKey="true" primaryKeyName="PK_HIVE_REJECTION_PHRASE"/>
            </column>
            <column name="TEXT" remarks="Текст отказа." type="VARCHAR(1000)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="5" author="hive">
        <addColumn tableName="HIVE_MISDEMEANOR">
            <column name="COLLEGE_REACTED"
                    remarks="Колледж отреагировал. Флаг взводится, только если последовала реакция колледжа.&#10;Если выполнены действия, флаг не взводится.&#10;&#10;&#10;Эта информация может быть извлечена из базы данных в таблицах&#10;Warning или Reprimand. Т.е. эта информация излешняя, но&#10;она несет удобство пользователю."
                    type="BOOLEAN"/>
            <column name="FILE_"
                    remarks="Возможность прикрепить файл. Это может быть, например, изображение.&#10;Файл служит доказательством проступка.&#10;Если факлов несколько, пользователи должны заархивировать файлы и&#10;приложить один файл с архивом."
                    type="VARCHAR(1024)"/>
            <column name="STUDENT_REACTED"
                    remarks="Студент отреагировал. Флаг взводится, только если последовала реакция колледжа.&#10;Если выполнены действия, флаг не взводится.&#10;&#10;Эта информация может быть извлечена из базы данных в таблицах&#10;Promise или StatementOfExplanation. Т.е. эта информация излешняя, но&#10;она несет удобство пользователю."
                    type="BOOLEAN"/>
        </addColumn>
    </changeSet>
    <changeSet id="6" author="hive">
        <addColumn tableName="HIVE_REJECTION_OF_PROMISE">
            <column name="CREATED_AT" remarks="Время создания." type="DATETIME"/>
        </addColumn>

        <addNotNullConstraint columnName="CREATED_AT" defaultNullValue="now()" tableName="HIVE_REJECTION_OF_PROMISE"/>
    </changeSet>
    <changeSet id="7" author="hive">
        <addColumn tableName="HIVE_STATEMENT_OF_EXPLANATION">
            <column name="FILE_"
                    remarks="Возможность прикрепить файл. Это может быть, например, изображение.&#10;Файл служит доказательством приводимых аргументов.&#10;Если факлов несколько, пользователи должны заархивировать файлы и&#10;приложить один файл с архивом."
                    type="VARCHAR(1024)"/>
        </addColumn>
    </changeSet>
    <changeSet id="8" author="hive">
        <addColumn tableName="HIVE_REPRIMAND">
            <column name="GRANTED_MERCY"
                    remarks="Прощен. Дублировние информации о прощении: если есть запись о прощении (Mercy),&#10;то она содержит информацию о том, какой именно выговор отменен. Но здесь флаг -&#10;только для сортировки и фильтрации."
                    type="BOOLEAN"/>
        </addColumn>
    </changeSet>
    <changeSet id="9" author="hive">
        <addColumn tableName="HIVE_MERCY">
            <column name="REPRIMAND_ID" remarks="Ссылка на выговор студенту." type="UUID"/>
        </addColumn>

        <addNotNullConstraint columnName="REPRIMAND_ID" tableName="HIVE_MERCY"/>
    </changeSet>
    <changeSet id="10" author="hive">
        <addColumn tableName="HIVE_REJECTION_OF_STATEMENT_OF_EXPLANATION">
            <column name="STATEMENT_OF_EXPLANATION_ID" remarks="Ссылка на объяснительную записку студента."
                    type="UUID"/>
        </addColumn>

        <addNotNullConstraint columnName="STATEMENT_OF_EXPLANATION_ID"
                              tableName="HIVE_REJECTION_OF_STATEMENT_OF_EXPLANATION"/>
    </changeSet>
    <changeSet id="11" author="hive">
        <addColumn tableName="HIVE_STUDENT">
            <column name="STUDY_GROUP_ID" type="UUID"/>
        </addColumn>

        <addNotNullConstraint columnName="STUDY_GROUP_ID" tableName="HIVE_STUDENT"/>
    </changeSet>
    <changeSet id="12" author="hive">
        <createIndex indexName="IDX_HIVEREJECTIONOFSTATEMENTOFEXPLANATIO_STATEMENTOFEXPLANATION"
                     tableName="HIVE_REJECTION_OF_STATEMENT_OF_EXPLANATION">
            <column name="STATEMENT_OF_EXPLANATION_ID"/>
        </createIndex>

        <addForeignKeyConstraint baseColumnNames="STATEMENT_OF_EXPLANATION_ID"
                                 baseTableName="HIVE_REJECTION_OF_STATEMENT_OF_EXPLANATION"
                                 constraintName="FK_HIVEREJECTIONOFSTATEMENTOFEXPLANAT_ON_STATEMENTOFEXPLANATION"
                                 referencedColumnNames="ID" referencedTableName="HIVE_STATEMENT_OF_EXPLANATION"/>
    </changeSet>
    <changeSet id="13" author="hive">
        <createIndex indexName="IDX_HIVE_ACCEPTANCE_OF_PROMISE_EMPLOYEE" tableName="HIVE_ACCEPTANCE_OF_PROMISE">
            <column name="EMPLOYEE_ID"/>
        </createIndex>

        <addForeignKeyConstraint baseColumnNames="EMPLOYEE_ID" baseTableName="HIVE_ACCEPTANCE_OF_PROMISE"
                                 constraintName="FK_HIVE_ACCEPTANCE_OF_PROMISE_ON_EMPLOYEE" referencedColumnNames="ID"
                                 referencedTableName="HIVE_USER"/>
    </changeSet>
    <changeSet id="14" author="hive">
        <createIndex indexName="IDX_HIVE_ACCEPTANCE_OF_PROMISE_PROMISE" tableName="HIVE_ACCEPTANCE_OF_PROMISE">
            <column name="PROMISE_ID"/>
        </createIndex>

        <addForeignKeyConstraint baseColumnNames="PROMISE_ID" baseTableName="HIVE_ACCEPTANCE_OF_PROMISE"
                                 constraintName="FK_HIVE_ACCEPTANCE_OF_PROMISE_ON_PROMISE" referencedColumnNames="ID"
                                 referencedTableName="HIVE_PROMISE"/>
    </changeSet>
    <changeSet id="15" author="hive">
        <createIndex indexName="IDX_HIVE_HISTORY_MISDEMEANOR" tableName="HIVE_HISTORY">
            <column name="MISDEMEANOR_ID"/>
        </createIndex>

        <addForeignKeyConstraint baseColumnNames="MISDEMEANOR_ID" baseTableName="HIVE_HISTORY"
                                 constraintName="FK_HIVE_HISTORY_ON_MISDEMEANOR" referencedColumnNames="ID"
                                 referencedTableName="HIVE_MISDEMEANOR"/>
    </changeSet>
    <changeSet id="16" author="hive">
        <createIndex indexName="IDX_HIVE_MERCY_REPRIMAND" tableName="HIVE_MERCY">
            <column name="REPRIMAND_ID"/>
        </createIndex>

        <addForeignKeyConstraint baseColumnNames="REPRIMAND_ID" baseTableName="HIVE_MERCY"
                                 constraintName="FK_HIVE_MERCY_ON_REPRIMAND" referencedColumnNames="ID"
                                 referencedTableName="HIVE_REPRIMAND"/>
    </changeSet>
    <changeSet id="17" author="hive">
        <createIndex indexName="IDX_HIVE_STUDENT_STUDY_GROUP" tableName="HIVE_STUDENT">
            <column name="STUDY_GROUP_ID"/>
        </createIndex>

        <addForeignKeyConstraint baseColumnNames="STUDY_GROUP_ID" baseTableName="HIVE_STUDENT"
                                 constraintName="FK_HIVE_STUDENT_ON_STUDY_GROUP" onDelete="CASCADE"
                                 referencedColumnNames="ID" referencedTableName="HIVE_STUDY_GROUP"/>
    </changeSet>
    <changeSet id="18" author="hive">
        <dropColumn columnName="promise_id" tableName="hive_mercy"/>
    </changeSet>
    <changeSet id="19" author="hive">
        <setTableRemarks
                remarks="Разрешение отреагировать на фиксацию проступка.&#10;Применяется, если студент упустил время, данное на то, чтобы отреагировать&#10;на обвинение.&#10;Иначе говоря, время уже прошло, но студенту разрешаем добавить&#10;обещание или объяснительную записку.&#10;&#10;Чтобы получить разрешение, студент должен обратиться на отделение лично (не&#10;через интерфейс &quot;Цифровой морали&quot;. Сделать форму обращения технически&#10;несложно, но воспитательное воздействие будет лучше, если студент придет&#10;на отделение или хотя бы позвонит."
                tableName="HIVE_PERMIT_TO_PROMISE"/>
    </changeSet>
    <changeSet id="20" author="hive">
        <setTableRemarks
                remarks="Объяснительная записка.&#10;Студент приводит уважительную причину или сообщает о несправедливости обвинений.&#10;В иных случаях писать объяснительную записку смысла нет.&#10;&#10;Писать объяснительную записку, нет никакого смысла, если студент не&#10;может привести в ней уважительных причин. Нет уважительных причин - значит,&#10;студент может только раскаяться и дать обещание исправиться."
                tableName="HIVE_STATEMENT_OF_EXPLANATION"/>
    </changeSet>
    <changeSet id="21" author="hive">
        <addNotNullConstraint columnDataType="CLOB" columnName="TEXT" tableName="HIVE_STATEMENT_OF_EXPLANATION"
                              validate="true"/>
    </changeSet>
</databaseChangeLog>